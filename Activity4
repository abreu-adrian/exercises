# Activity 4: Assess differentially abundant taxa between Abx and Abx+C.albicans

ps_filt <- ps %>%
  subset_samples(Treatment_Group == "Abx" | Treatment_Group == "Abx+C.albicans")

phTOds = phyloseq_to_deseq2(ps_filt, ~ Treatment_Group)
is(phTOds); isS4(phTOds)

slotNames(phTOds) 

fcs = estimateSizeFactors(phTOds)

dsp = estimateDispersions(fcs)
plotDispEsts(dsp)

deseq = DESeq(dsp, test="Wald", fitType="parametric") 

res = results(deseq, cooksCutoff = FALSE) 
alpha = 0.05 
sigtab = res[which(res$padj < alpha), ] 
sigtab = cbind(as(sigtab, "data.frame"), as(tax_table(ps)[rownames(sigtab), ], "matrix")) 
head(sigtab %>% dplyr::select(log2FoldChange, padj, Genus)) 


x = tapply(sigtab$log2FoldChange, sigtab$Genus, function(x) max(x)) 
x = sort(x, TRUE) 
sigtab$Genus = factor(as.character(sigtab$Genus), levels=names(x))

nb.cols <- 25
mycolors <- colorRampPalette(brewer.pal(25, "PiYG"))(nb.cols)
fig_AbxCAbx <- ggplot(sigtab, aes(x=Genus, y=log2FoldChange, color=Genus)) + geom_point(size=6) + 
  labs(title = "Differentially abundant genera in Abx vs Abx+C.albicans") +
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, face = "italic"),
        legend.text = element_text(face = "italic"))+
  scale_colour_manual(values=mycolors)+
  scale_fill_manual(values=mycolors) 
fig_AbxCAbx
